<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">    
    <title>Hrientec - Data Collection</title>
    <!-- Tailwind CSS for modern UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LINE SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root {
            --hrientec-blue: #004a99; /* โทนสีน้ำเงินจากโลโก้ hrientec */
            --hrientec-light: #f4f7f6;
        }
        body { background-color: var(--hrientec-light); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .btn-primary { background-color: var(--hrientec-blue); transition: all 0.3s; }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
        .loader { border-top-color: var(--hrientec-blue); animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .config-warning {
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            color: #b91c1c;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-md mx-auto bg-white rounded-xl shadow-lg overflow-hidden border-t-4 border-[#004a99]">
        <!-- Header Section -->
        <div class="p-6 text-center border-b">
            <h1 class="text-2xl font-bold text-[#004a99]">Data Collection</h1>
            <p class="text-gray-500 text-sm mt-1">Hrientec Engineering & Technology</p>
        </div>

        <!-- Form Section -->
        <form id="dataForm" class="p-6 space-y-5">
            <div id="setupWarning" class="hidden config-warning">
                <strong>Warning:</strong> Please configure <code>WEB_APP_URL</code> and <code>LIFF_ID</code> in the code.
            </div>

            <!-- 1. LINE Name (Auto-filled) -->
            <div>
                <label class="block text-sm font-medium text-gray-700">Name (LINE Name)</label>
                <input type="text" id="lineName" readonly class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md text-gray-600 shadow-sm focus:outline-none" placeholder="Loading profile...">
            </div>

            <!-- 2. Project Selection -->
            <div>
                <label class="block text-sm font-medium text-gray-700">Project <span class="text-red-500">*</span></label>
                <select id="project" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#004a99] focus:border-[#004a99]">
                    <option value="" disabled selected>-- Loading projects... --</option>
                </select>
            </div>

            <!-- 3. Details -->
            <div>
                <label class="block text-sm font-medium text-gray-700">Work Details</label>
                <textarea id="details" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#004a99] focus:border-[#004a99]" placeholder="Enter details..."></textarea>
            </div>

            <!-- Submit Button -->
            <button type="submit" id="submitBtn" class="w-full btn-primary text-white font-bold py-3 px-4 rounded-lg shadow-md disabled:bg-gray-400">
                <span id="btnText">Submit Data</span>
            </button>
        </form>
    </div>

    <!-- Processing Overlay -->
    <div id="loader" class="fixed inset-0 bg-black/50 hidden flex flex-col items-center justify-center z-50">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
        <h2 class="text-white text-xl font-semibold">Processing...</h2>
    </div>

    <script>
        // --- CONFIGURATION ---
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwQG8oY7s7nI1PqIKwkFw47tOxUXmOJ5oanQR6ebhri3L8XNr6OW1edt1FCnYFIGP2Y/exec"; 
        const LIFF_ID = "2009016720-tTy5Qvq2"; 

        let userData = { name: '', userId: '' };

        function isConfigValid() {
            return WEB_APP_URL.startsWith("https://") && !LIFF_ID.includes("_ของคุณ");
        }

        async function initLiff() {
            if (!isConfigValid()) {
                document.getElementById('setupWarning').classList.remove('hidden');
                document.getElementById('project').innerHTML = '<option value="">-- Please set URL in code --</option>';
                return;
            }

            fetchProjects(); 
            
            try {
                await liff.init({ liffId: LIFF_ID });
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    userData.name = profile.displayName;
                    userData.userId = profile.userId;
                    document.getElementById('lineName').value = userData.name;
                } else {
                    liff.login();
                }
            } catch (err) {
                console.error("LIFF Init Error:", err);
                document.getElementById('lineName').placeholder = "Cannot connect to LINE";
            }
        }

        async function fetchProjects() {
            const select = document.getElementById('project');
            try {
                const response = await fetch(WEB_APP_URL);
                if (!response.ok) throw new Error("Network response was not ok");
                
                const data = await response.json();
                
                if (data.status === "success" && data.projects) {
                    select.innerHTML = '<option value="">-- Please select project --</option>';
                    data.projects.forEach(p => {
                        let opt = document.createElement('option');
                        opt.value = p;
                        opt.innerHTML = p;
                        select.appendChild(opt);
                    });
                } else {
                    throw new Error(data.message || "Data format error");
                }
            } catch (err) {
                console.error("Fetch Projects Error:", err);
                select.innerHTML = '<option value="">-- Failed to load projects --</option>';
            }
        }

        document.getElementById('dataForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!isConfigValid()) {
                alert("System is not configured yet.");
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            const loader = document.getElementById('loader');
            
            const payload = {
                lineName: userData.name || "Anonymous",
                userId: userData.userId || "n/a",
                project: document.getElementById('project').value,
                details: document.getElementById('details').value
            };

            loader.classList.remove('hidden');
            submitBtn.disabled = true;

            try {
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // --- ENGLISH RETURN MESSAGE ---
                if (liff.isInClient()) {
                    await liff.sendMessages([{
                        type: 'text',
                        text: `✅ Submission Successful\n\nName: ${payload.lineName}\nProject: ${payload.project}\nTime: ${new Date().toLocaleString('en-US', { hour12: false })}`
                    }]);
                }

                setTimeout(() => {
                    liff.closeWindow();
                }, 1500);

            } catch (err) {
                console.error("Submission Error:", err);
                alert("Error while saving data. Please try again.");
                loader.classList.add('hidden');
                submitBtn.disabled = false;
            }
        });

        window.onload = initLiff;
    </script>
</body>
</html>